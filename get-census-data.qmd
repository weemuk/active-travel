---
format: gfm
---


Search for census data with https://www.google.com/search?q=census+2011+middle+super+output+area+data+travel+to+work 

From https://statistics.ukdataservice.ac.uk/dataset/method-travel-work-england-and-wales-2011 select Middle Super Output Area (MSOA) data for England and Wales, and download the CSV file.

```{r}
#| include: false
library(tidyverse)
library(sf)
```

```{r}
data_url = "https://ukds-ckan.s3.eu-west-1.amazonaws.com/AGE_MTTWRK/AGE_MTTWRK_MSOAIZ_England_Wales_Descriptions.csv"
msoa_work_data = read_csv(data_url)
dim(msoa_work_data)
names(msoa_work_data)
# [1] "GEO_CODE"                                                                                                      
#  [2] "GEO_LABEL"                                                                                                     
#  [3] "GEO_TYPE"                                                                                                      
#  [4] "GEO_TYP2"                                                                                                      
#  [5] "Age : Age 16 to 74 - Travel to place of work; means of : Total\\ Method of travel to work - Unit : Persons"    
#  [6] "Age : Age 16 to 74 - Travel to place of work; means of : Work mainly at or from home - Unit : Persons"         
#  [7] "Age : Age 16 to 74 - Travel to place of work; means of : Underground; metro; light rail; tram - Unit : Persons"
#  [8] "Age : Age 16 to 74 - Travel to place of work; means of : Train - Unit : Persons"                               
#  [9] "Age : Age 16 to 74 - Travel to place of work; means of : Bus; minibus or coach - Unit : Persons"               
# [10] "Age : Age 16 to 74 - Travel to place of work; means of : Taxi - Unit : Persons"                                
# [11] "Age : Age 16 to 74 - Travel to place of work; means of : Motorcycle; scooter or moped - Unit : Persons"        
# [12] "Age : Age 16 to 74 - Travel to place of work; means of : Driving a car or van - Unit : Persons"                
# [13] "Age : Age 16 to 74 - Travel to place of work; means of : Passenger in a car or van - Unit : Persons"           
# [14] "Age : Age 16 to 74 - Travel to place of work; means of : Bicycle - Unit : Persons"                             
# [15] "Age : Age 16 to 74 - Travel to place of work; means of : On foot - Unit : Persons"                             
# [16] "Age : Age 16 to 74 - Travel to place of work; means of : Other method of travel to work - Unit : Persons"      
# [17] "Age : Age 16 to 74 - Travel to place of work; means of : Not in employment - Unit : Persons" 
# Update column names and only keep the columns we need with transmute:
msoa_work_data = msoa_work_data |>
  transmute(
    msoa_code = GEO_CODE,
    total = `Age : Age 16 to 74 - Travel to place of work; means of : Total\\ Method of travel to work - Unit : Persons`,
    work_from_home = `Age : Age 16 to 74 - Travel to place of work; means of : Work mainly at or from home - Unit : Persons`,
    light_rail = `Age : Age 16 to 74 - Travel to place of work; means of : Underground; metro; light rail; tram - Unit : Persons`,
    train = `Age : Age 16 to 74 - Travel to place of work; means of : Train - Unit : Persons`,
    bus = `Age : Age 16 to 74 - Travel to place of work; means of : Bus; minibus or coach - Unit : Persons`,
    taxi = `Age : Age 16 to 74 - Travel to place of work; means of : Taxi - Unit : Persons`,
    motorcycle = `Age : Age 16 to 74 - Travel to place of work; means of : Motorcycle; scooter or moped - Unit : Persons`,
    car_driver = `Age : Age 16 to 74 - Travel to place of work; means of : Driving a car or van - Unit : Persons`,
    car_passenger = `Age : Age 16 to 74 - Travel to place of work; means of : Passenger in a car or van - Unit : Persons`,
    bicycle = `Age : Age 16 to 74 - Travel to place of work; means of : Bicycle - Unit : Persons`,
    on_foot = `Age : Age 16 to 74 - Travel to place of work; means of : On foot - Unit : Persons`,
    other_method_travel_to_work = `Age : Age 16 to 74 - Travel to place of work; means of : Other method of travel to work - Unit : Persons`,
    not_in_employment = `Age : Age 16 to 74 - Travel to place of work; means of : Not in employment - Unit : Persons`
  )
```

Download msoa boundaries from https://geoportal.statistics.gov.uk and read the shapefile with st_read.

This is the dataset we'll use: https://geoportal.statistics.gov.uk/datasets/8200e7683bba4de8a1a47e6b1c323099_0/explore?location=53.345186%2C-0.761311%2C15 

```{r}
url_msoas = "https://services1.arcgis.com/ESMARspQHYMw9BZ9/arcgis/rest/services/MSOA_Dec_2011_Boundaries_Super_Generalised_Clipped_BSC_EW_V3_2022/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"
msoas = read_sf(url_msoas)
names(msoas)
msoas = msoas |>
  transmute(
    msoa_code = MSOA11CD
  )
msoas_2011 = msoas |>
  left_join(msoa_work_data, by = "msoa_code")
```

```{r}
#| label: msoa-cycle-to-work
#| eval: false
msoas_2011 = msoas_2011 |>
  select(bicycle) |>
  plot()
```

```{r}
#| label: msoa-cycle-to-work-choropleth-ggplot2
# Figure out how to get the numbers as percentages...
# msoas_2011_percentages = msoas_2011 |>
#   transmute(
#     msoa_code,
#     across(c(total, work_from_home, light_rail, train, bus, taxi, motorcycle, car_driver, car_passenger, bicycle, on_foot, other_method_travel_to_work, not_in_employment), ~ .x / total))
msoas_2011 |>
  ggplot() +
  geom_sf(aes(fill = bicycle, colour = NULL)) +
  scale_fill_viridis_c() 
```

Next steps: try getting percent cycling in each zone, aggregate by local authorities and regions, get 2021 data, improve the plot with better colour scales, labels, etc.